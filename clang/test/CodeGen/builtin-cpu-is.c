// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// RUN: %clang_cc1 -triple x86_64-pc-linux-gnu -emit-llvm %s -o - | FileCheck %s --check-prefix=CHECK-X86
// RUN: %clang_cc1 -triple riscv64-unknown-linux-gnu -emit-llvm %s -o - | FileCheck %s --check-prefix=CHECK-RV64

#ifdef __x86_64__
// Test that we have the structure definition, the gep offsets, the name of the
// global, the bit grab, and the icmp correct.
extern void a(const char *);

// CHECK-X86-LABEL: define dso_local void @intel(
// CHECK-X86-SAME: ) #[[ATTR0:[0-9]+]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr @__cpu_model, align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 1
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void intel(void) {
  if (__builtin_cpu_is("intel"))
    a("intel");
}

// CHECK-X86-LABEL: define dso_local void @amd(
// CHECK-X86-SAME: ) #[[ATTR0]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr @__cpu_model, align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 2
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str.1)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void amd(void) {
  if (__builtin_cpu_is("amd"))
    a("amd");
}

// CHECK-X86-LABEL: define dso_local void @atom(
// CHECK-X86-SAME: ) #[[ATTR0]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr getelementptr inbounds ({ i32, i32, i32, [1 x i32] }, ptr @__cpu_model, i32 0, i32 1), align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 1
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str.2)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void atom(void) {
  if (__builtin_cpu_is("atom"))
    a("atom");
}

// CHECK-X86-LABEL: define dso_local void @amdfam10h(
// CHECK-X86-SAME: ) #[[ATTR0]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr getelementptr inbounds ({ i32, i32, i32, [1 x i32] }, ptr @__cpu_model, i32 0, i32 1), align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 4
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str.3)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void amdfam10h(void) {
  if (__builtin_cpu_is("amdfam10h"))
    a("amdfam10h");
}

// CHECK-X86-LABEL: define dso_local void @barcelona(
// CHECK-X86-SAME: ) #[[ATTR0]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr getelementptr inbounds ({ i32, i32, i32, [1 x i32] }, ptr @__cpu_model, i32 0, i32 2), align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 4
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str.4)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void barcelona(void) {
  if (__builtin_cpu_is("barcelona"))
    a("barcelona");
}

// CHECK-X86-LABEL: define dso_local void @nehalem(
// CHECK-X86-SAME: ) #[[ATTR0]] {
// CHECK-X86-NEXT:  [[ENTRY:.*:]]
// CHECK-X86-NEXT:    [[TMP0:%.*]] = load i32, ptr getelementptr inbounds ({ i32, i32, i32, [1 x i32] }, ptr @__cpu_model, i32 0, i32 2), align 4
// CHECK-X86-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 1
// CHECK-X86-NEXT:    br i1 [[TMP1]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
// CHECK-X86:       [[IF_THEN]]:
// CHECK-X86-NEXT:    call void @a(ptr noundef @.str.5)
// CHECK-X86-NEXT:    br label %[[IF_END]]
// CHECK-X86:       [[IF_END]]:
// CHECK-X86-NEXT:    ret void
//
void nehalem(void) {
  if (__builtin_cpu_is("nehalem"))
    a("nehalem");
}
#endif

#ifdef __riscv
// CHECK-RV64-LABEL: define dso_local signext i32 @test_cpu_is_veyron_v1(
// CHECK-RV64-SAME: ) #[[ATTR0:[0-9]+]] {
// CHECK-RV64-NEXT:  [[ENTRY:.*:]]
// CHECK-RV64-NEXT:    [[TMP0:%.*]] = load i32, ptr @__riscv_cpu_model, align 4
// CHECK-RV64-NEXT:    [[TMP1:%.*]] = icmp eq i32 [[TMP0]], 1567
// CHECK-RV64-NEXT:    [[TMP2:%.*]] = load i64, ptr getelementptr inbounds ({ i32, i64, i64 }, ptr @__riscv_cpu_model, i32 0, i32 1), align 8
// CHECK-RV64-NEXT:    [[TMP3:%.*]] = icmp eq i64 [[TMP2]], -9223372036854710272
// CHECK-RV64-NEXT:    [[TMP4:%.*]] = and i1 [[TMP1]], [[TMP3]]
// CHECK-RV64-NEXT:    [[TMP5:%.*]] = load i64, ptr getelementptr inbounds ({ i32, i64, i64 }, ptr @__riscv_cpu_model, i32 0, i32 2), align 8
// CHECK-RV64-NEXT:    [[TMP6:%.*]] = icmp eq i64 [[TMP5]], 273
// CHECK-RV64-NEXT:    [[TMP7:%.*]] = and i1 [[TMP4]], [[TMP6]]
// CHECK-RV64-NEXT:    [[CONV:%.*]] = zext i1 [[TMP7]] to i32
// CHECK-RV64-NEXT:    ret i32 [[CONV]]
//
int test_cpu_is_veyron_v1() {
  return __builtin_cpu_is("veyron-v1");
}
#endif
